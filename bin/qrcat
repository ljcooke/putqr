#!/usr/bin/env ruby
require 'base64'
require 'rqrcode'

def qrcode(content)
  # Try each size until one fits
  (1..40).each do |size|
    begin
      return RQRCode::QRCode.new(content, level: :h, size: size)
    rescue RQRCode::QRCodeRunTimeError
      next
    end
  end
  nil
end

def ansi(qrcode)
  qrcode.as_ansi
end

def iterm2_image(qrcode)
  png = qrcode.as_png(size: 600)
  png_base64 = Base64.encode64(png.to_s).chomp
  options = "inline=1"
  "\033]1337;File=#{options}:#{png_base64}\007"
end

if ENV['TERM_PROGRAM'] == 'iTerm.app'
  puts iterm2_image qrcode $stdin.read
else
  puts ansi qrcode $stdin.read
end
